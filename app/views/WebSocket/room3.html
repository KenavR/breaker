#{extends 'main.html' /}
#{set title:'Chat room' /}

#{set 'moreScripts'}
<link rel="stylesheet" href="@{'/public/libs/assets/animate.css/animate.css'}" type="text/css"/>
<link rel="stylesheet" href="@{'/public/libs/assets/font-awesome/css/font-awesome.min.css'}" type="text/css"/>
<link rel="stylesheet" href="@{'/public/libs/assets/simple-line-icons/css/simple-line-icons.css'}" type="text/css"/>
<link rel="stylesheet" href="@{'/public/libs/jquery/bootstrap/dist/css/bootstrap.css'}" type="text/css"/>

<link rel="stylesheet" href="@{'/public/css/font.css'}" type="text/css"/>
<link rel="stylesheet" href="@{'/public/css/app.css'}" type="text/css"/>
<link rel="stylesheet" href="@{'/public/stylesheets/angulr-custom.css'}" type="text/css"/>

<link href="@{'/public/stylesheets/messenger.css'}" rel="stylesheet" type="text/css" />
<link href="@{'/public/stylesheets/messenger-theme-flat.css'}" rel="stylesheet" type="text/css" />
<link href="@{'/public/stylesheets/jquery.mentionsInput.css'}" rel="stylesheet" type="text/css" />
<link href="@{'/public/stylesheets/screen.css'}" rel="stylesheet" type="text/css" />
#{/set}

<body>

<!-- Templates -->

<script type="text/html" id="roomentry_tmpl">
    <li id="<%= getRoomlistEntrySelector(roomObj.name).substring(1) %>">
        <a href="#" class="roomselect" data-roomname="<%= roomObj.name %>">
            <b class="unreadcount label bg-info pull-right"></b>
            <!--<i class="glyphicon glyphicon-envelope icon text-info-lter"></i>-->
            <span class="roomname">#<%= roomObj.name %></span>
        </a>
    </li>
</script>


<script type="text/html" id="userentry_tmpl">
    <li id="<%= getUserEntrySelector(roomName, user.username).substring(1) %>" class="list-group-item">
        <a href="https://reddit.com/u/<%= user.username %>" class="pull-left thumb-sm avatar m-r" target="_blank">
            <img src="<%= user.profileImageUrl %>" alt="..." class="img-circle">
            <i class="on b-white bottom"></i>
        </a>
        <div class="clear">
            <div><a href="https://reddit.com/u/<%= user.username %>" target="_blank"><%= user.username %></a></div>
            <small class="text-muted"><%= user.statusMessage ? user.statusMessage : '&nbsp;' %></small>
        </div>
    </li>
</script>


<script type="text/html" id="message_tmpl">
    <% if(event.type == 'message') { %>
    <li id="<%= getMessageSelector(event.message.uuid).substring(1) %>" class="list-group-item no-border p-t-s p-b-xs clearfix b-l-3x b-l-white">
        <a class="avatar thumb-sm pull-left m-r" href="https://reddit.com/u/<%= event.user.username %>" target="_blank">
            <img src="<%= event.user.profileImageUrl.indexOf('user-anon') > -1 ? '/public/img/user-empty.png' :  event.user.profileImageUrl %>">
        </a>
        <div class="pull-right text-sm text-muted">
            <span class="hidden-xs timeago" title="<%= new Date(event.timestamp).toISOString() %>">less than</span>
        </div>
        <div class="clear">
            <div><a class="text-md text-dark-dker" href="https://reddit.com/u/<%= event.user.username %>" target="_blank"><%= event.user.username %></a>
                <!--<span class="label bg-light m-l-sm ">angular</span>--></div>
            <div class="m-t-midxs"><%= event.message.messageHtml %></div>
            <% if (event.message.imageLinks && event.message.imageLinks.length > 0) { %>
            <div class="m-t-sm">
                <a href="<%= event.message.imageLinks[0] %>" target="_blank">
                    <img src='<%= event.message.imageLinks[0] %>' class="image-preview" onload="previewLoaded();"/>
                </a>
            </div>
            <% } %>
        </div>
    </li>
    <% } %>
    <% if(event.type == 'join') { %>
<!--
    <div class="message notice">
        <h2></h2>
        <p>
            <%= event.user.username %> joined the room
        </p>
    </div>
-->
    <% } %>
    <% if(event.type == 'leave') { %>
<!--
    <div class="message notice">
        <h2></h2>
        <p>
            <%= event.user.username %> left the room
        </p>
    </div>
-->
    <% } %>
    <% if(event.type == 'quit') { %>
<!--
    <div class="message important">
        <h2></h2>
        <p>
            You are now disconnected!
        </p>
    </div>
-->
    <% } %>
</script>

<script type="text/html" id="messageshort_tmpl">
    <li id="<%= getMessageSelector(event.message.uuid).substring(1) %>" class="list-group-item p-t-none p-b-xs no-border clearfix b-l-3x b-l-white">
        <a class="avatar thumb-sm pull-left m-r" href="https://reddit.com/u/<%= event.user.username %>" target="_blank">
            &nbsp;
        </a>
        <div class="clear">
            <div class="m-t-xs "><%= event.message.messageHtml %></div>
            <% if (event.message.imageLinks && event.message.imageLinks.length > 0) { %>
            <div class="m-t-sm">
                <a href="<%= event.message.imageLinks[0] %>" target="_blank">
                    <img src='<%= event.message.imageLinks[0] %>' class="image-preview" onload="previewLoaded();"/>
                </a>
            </div>
            <% } %>
        </div>
    </li>
</script>
<!-- end templates -->

<div class="app app-header-fixed app-aside-fixed">

    <!-- header -->
    <header id="header" class="app-header navbar" role="menu">
        <!-- navbar header -->
        <div class="navbar-header bg-dark">
            <button class="pull-right visible-xs dk" ui-toggle-class="show" target=".navbar-collapse">
                <i class="glyphicon glyphicon-cog"></i>
            </button>
            <button class="pull-right visible-xs" ui-toggle-class="off-screen" target=".app-aside" ui-scroll="app">
                <i class="glyphicon glyphicon-align-justify"></i>
            </button>
            <!-- brand -->
            <a href="#" class="navbar-brand text-lt">
                <i class="fa fa-terminal"></i>
                <!--<img src="/public/img/logo.png" alt="." class="hide">-->
                <span class="hidden-folded m-l-xs">breaker</span>
            </a>
            <!-- / brand -->
        </div>
        <!-- / navbar header -->

        <!-- navbar collapse -->
        <div class="collapse pos-rlt navbar-collapse box-shadow bg-white-only">
            <!-- buttons -->
            <!--
                        <div class="nav navbar-nav hidden-xs">
                            <a href="#" class="btn no-shadow navbar-btn" ui-toggle-class="app-aside-folded" target=".app">
                                <i class="fa fa-dedent fa-fw text"></i>
                                <i class="fa fa-indent fa-fw text-active"></i>
                            </a>
                            <a href="#" class="btn no-shadow navbar-btn" ui-toggle-class="show" target="#aside-user">
                                <i class="icon-user fa-fw"></i>
                            </a>
                        </div>
            -->
            <!-- / buttons -->

            <span class="m-t-xs m-r-sm floatleft">
                <img id="room-icon" width="40" height="40"/>
            </span>

            <ul class="nav navbar-nav hidden-sm" >

                <li class="m-t-xs m-b-xxs middle" >
                    <span id="room-title" class="h4 m-n font-thin h4 text-black"><a id="room-link" href="#" target="_blank">#roomname</a></span> <span><a id="room-pref" class="hidden">(customize)</a></span><br/>
                    <small id="room-modmessage" class="text-muted">
                        Message from the moderators to you, the user.
                    </small>
                </li>

            </ul>

            <!-- nabar right -->
            <ul class="nav navbar-nav navbar-right">
<!--
                <li class="dropdown">
                    <a href="#" data-toggle="dropdown" class="dropdown-toggle">
                        <i class="icon-bell fa-fw"></i>
                        <span class="visible-xs-inline">Notifications</span>
                        <span class="badge badge-sm up bg-danger pull-right-xs">2</span>
                    </a>
                    &lt;!&ndash; dropdown &ndash;&gt;
                    <div class="dropdown-menu w-xl animated fadeInUp">
                        <div class="panel bg-white">
                            <div class="panel-heading b-light bg-light">
                                <strong>You have <span>2</span> notifications</strong>
                            </div>
                            <div class="list-group">
                                <a href class="list-group-item">
                    <span class="pull-left m-r thumb-sm">
                      <img src="/public/img/a4.jpg" alt="..." class="img-circle">
                    </span>
                    <span class="clear block m-b-none">
                      Use awesome animate.css<br>
                      <small class="text-muted">10 minutes ago</small>
                    </span>
                                </a>
                                <a href class="list-group-item">
                    <span class="clear block m-b-none">
                      1.0 initial released<br>
                      <small class="text-muted">1 hour ago</small>
                    </span>
                                </a>
                            </div>
                            <div class="panel-footer text-sm">
                                <a href class="pull-right"><i class="fa fa-cog"></i></a>
                                <a href="#notes" data-toggle="class:show animated fadeInRight">See all the
                                    notifications</a>
                            </div>
                        </div>
                    </div>
                    &lt;!&ndash; / dropdown &ndash;&gt;
                </li>
-->
                <li class="dropdown v-middle">
                    <a href="#" data-toggle="dropdown" class="dropdown-toggle clear" data-toggle="dropdown">
                      <span class="thumb-sm avatar pull-right m-t-n-sm m-b-n-sm m-l-sm">
                        <img src="${user.getProfileImageUrl()}" alt="...">
                        <i class="on md b-white bottom"></i>
                      </span>
                        <span class="hidden-sm hidden-md">${user.username}</span> <b class="caret"></b>
                    </a>
                    <!-- dropdown -->
                    <ul class="dropdown-menu w">
<!--
                        <li class="wrapper b-b m-b-sm bg-light m-t-n-xs">
                            <div>
                                <p>300mb of 500mb used</p>
                            </div>
                            <div class="progress progress-xs m-b-none dker">
                                <div class="progress-bar progress-bar-info" data-toggle="tooltip"
                                     data-original-title="50%" style="width: 50%"></div>
                            </div>
                        </li>
                        <li>
                            <a href>
                                <span class="badge bg-danger pull-right">30%</span>
                                <span>Settings</span>
                            </a>
                        </li>
                        <li>
                            <a ui-sref="app.page.profile">Profile</a>
                        </li>
                        <li>
                            <a ui-sref="app.docs">
                                <span class="label bg-info pull-right">new</span>
                                Help
                            </a>
                        </li>
                        <li class="divider"></li>
-->
                        <li>
                            <a ui-sref="access.signin" href="@{UserManage.prefs()}">Preferences</a>
                        </li>
                        <li>
                            <a ui-sref="access.signin" href="@{Application.logout}">Logout</a>
                        </li>
                    </ul>
                    <!-- / dropdown -->
                </li>
            </ul>
            <!-- / navbar right -->
        </div>
        <!-- / navbar collapse -->
    </header>
    <!-- / header -->


    <!-- aside -->
    <aside id="aside" class="app-aside hidden-xs bg-dark">
        <div class="aside-wrap">
            <div class="navi-wrap">
                <!-- user -->
                <div class="clearfix hidden-xs text-center hide" id="aside-user">
                    <div class="dropdown wrapper">
                        <a href="app.page.profile">
                <span class="thumb-lg w-auto-folded avatar m-t-sm">
                  <img src="/public/img/user-anon.png" class="img-full" alt="...">
                </span>
                        </a>
                        <a href="#" data-toggle="dropdown" class="dropdown-toggle hidden-folded">
                <span class="clear">
                  <span class="block m-t-sm">
                    <strong class="font-bold text-lt">John.Smith</strong> 
                    <b class="caret"></b>
                  </span>
                  <span class="text-muted text-xs block">Art Director</span>
                </span>
                        </a>
                        <!-- dropdown -->
                        <ul class="dropdown-menu animated fadeInRight w hidden-folded">
                            <li class="wrapper b-b m-b-sm bg-info m-t-n-xs">
                                <span class="arrow top hidden-folded arrow-info"></span>
                                <div>
                                    <p>300mb of 500mb used</p>
                                </div>
                                <div class="progress progress-xs m-b-none dker">
                                    <div class="progress-bar bg-white" data-toggle="tooltip" data-original-title="50%"
                                         style="width: 50%"></div>
                                </div>
                            </li>
                            <li>
                                <a href>Settings</a>
                            </li>
                            <li>
                                <a href="page_profile.html">Profile</a>
                            </li>
                            <li>
                                <a href>
                                    <span class="badge bg-danger pull-right">3</span>
                                    Notifications
                                </a>
                            </li>
                            <li class="divider"></li>
                            <li>
                                <a href="page_signin.html">Logout</a>
                            </li>
                        </ul>
                        <!-- / dropdown -->
                    </div>
                    <div class="line dk hidden-folded"></div>
                </div>
                <!-- / user -->

                <!-- nav -->
                <nav ui-nav class="navi clearfix">
                    <ul id="roomlist" class="nav">
                        <li class="hidden-folded padder m-t m-b-sm text-muted text-xs">
                            <span>Rooms</span>
                        </li>

<!--
                        <li>
                            <a href="mail.html">
                                <b class="label bg-info pull-right">9</b>
                                &lt;!&ndash;<i class="glyphicon glyphicon-envelope icon text-info-lter"></i>&ndash;&gt;
                                <span class="font-bold">#${roomName}</span>
                            </a>
                        </li>
-->
                    </ul>
                </nav>

            </div>
        </div>
    </aside>
    <!-- / aside -->


    <!-- content -->
    <div id="content" class="app-content" role="main">
        <div class="app-content-body app-content-full h-full">


            <!-- hbox layout -->
            <div class="hbox hbox-auto-xs bg-light " ng-init="
                  app.settings.asideFolded = true;
                  app.settings.asideFixed = true;
                  app.settings.asideDock = false;
                  app.settings.container = false;
                  app.hideAside = false
                  ">
                <!-- column -->
                <div id="centercol" class="col">

                    <div id="threadparent" class="vbox">
                        <div class="row-row">
                            <div id="thread_scrollparent" class="cell">
                                <div class="cell-inner">

                                    <!-- The list of messages -->
                                    <ul id="thread" class="list-group list-group-lg no-radius m-b-none m-t-n-xxs">
                                        <!-- Filled in dynamically -->
                                    </ul>
                                    <!-- / list of messages -->

                                    <div id="bottom-spacer" class="padder-v-sm bg-white b-l-3x b-l-white"></div>
                                </div>
                            </div>
                        </div>

                        <div class="padder padder-v b-t b-light text-center">
                            <textarea type="text" class="form-control input-message mention"
                                   placeholder="Type a message to ${roomName}..."></textarea>
                        </div>

                    </div>
                </div>
                <!-- /column -->

                <!-- column -->
                <div id="rightcol" class="col w-md lter b-l hidden-sm hidden-xs">
                    <div id="userlistparent" class="vbox">
                        <div class="row-row">
                            <div class="cell scrollable hover">
                                <div class="cell-inner">
                                    <div role="tabpanel" class="tab-pane active" id="tab-1">
                                        <div class="wrapper-md">
                                            <div class="m-b-sm text-md">Users</div>
                                            <ul id='userlist' class="list-group no-bg no-borders pull-in">
                                                <!-- Filled in dynamically -->
                                            </ul>
                                            <!--
                                                                            <div class="text-center">
                                                                                <a href class="btn btn-sm btn-primary padder-md m-b">More Connections</a>
                                                                            </div>
                                            -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /column -->
            </div>
            <!-- /hbox layout -->


        </div>
    </div>
    <!-- /content -->

    <!-- footer -->
    <!--
        <footer id="footer" class="app-footer" role="footer">
            <div class="wrapper b-t bg-light">
                <span class="pull-right">2.1.0 <a href ui-scroll="app" class="m-l-sm text-muted"><i
                        class="fa fa-long-arrow-up"></i></a></span>
                &copy; 2015 Copyright.
            </div>
        </footer>
    -->
    <!-- / footer -->


</div>

<script src="@{'/public/libs/jquery/bootstrap/dist/js/bootstrap.js'}"></script>
<script src="@{'/public/js/ui-load.js'}"></script>
<script src="@{'/public/js/ui-jp.config.js'}"></script>
<script src="@{'/public/js/ui-jp.js'}"></script>
<script src="@{'/public/js/ui-nav.js'}"></script>
<script src="@{'/public/js/ui-toggle.js'}"></script>
<script src="@{'/public/js/ui-client.js'}"></script>

<script src="@{'/public/javascripts/underscore-min.js'}"></script>
<script src="@{'/public/javascripts/jquery.mentionsInput.js'}"></script>
<script src="@{'/public/javascripts/jquery.elastic.source.js'}"></script>

<script src="@{'/public/javascripts/reconnecting-websocket.min.js'}" type="text/javascript"
        charset="${_response_encoding}"></script>
<script src="@{'/public/javascripts/staydown.js'}" type="text/javascript" charset="${_response_encoding}"></script>
<script src="@{'/public/javascripts/jquery.timeago.js'}" type="text/javascript" charset="${_response_encoding}"></script>
<script src="@{'/public/javascripts/messenger.min.js'}" type="text/javascript"></script>
<script src="@{'/public/javascripts/messenger-theme-flat.js'}" type="text/javascript"></script>


<script type="text/javascript">

    // Create a socket
    // var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket;

    var numNewMessagesTotal = 0;
    var preSelectRoomName = '${roomName}';
    var hasFocus = true;
    var rooms = [];
    var stayDownObjs = [];
    var lastMessageUsernameForRoom = [];
    var currentSelectedRoomName;
    var socket;
    var firstTimeRoomList = true;

    var getIndexForRoom = function (roomName) {
        for (var i = 0; i < rooms.length; i++) {
            var roomObj = rooms[i];
            if (roomName === roomObj.name) {
                return i;
            }
        }
        return -1;
    };

    var getRoomForName = function (roomName) {
        return rooms[getIndexForRoom(roomName)];
    };

    var getCurrentSelectedRoomObject = function() {
        return getRoomForName(currentSelectedRoomName);
    };

    var getStaydownForRoom = function (roomName) {
        return stayDownObjs[getIndexForRoom(roomName)];
    };

    var getLastMessageUsernameForRoom = function (roomName) {
        return lastMessageUsernameForRoom[getIndexForRoom(roomName)];
    };

    var setLastMessageUsernameForRoom = function (roomName, username) {
        lastMessageUsernameForRoom[getIndexForRoom(roomName)] = username;
    };

    // Connect socket after DOM ready
    // not totally sure if this is necessary but seems sensible
    $(function() {
        // See https://github.com/joewalnes/reconnecting-websocket for options:
        var websocketUrl = '@@{WebSocket.ChatRoomSocket.join()}';
        websocketUrl = websocketUrl.replace('ws:', 'wss:');
        socket = new ReconnectingWebSocket(websocketUrl);
        // socket.debug = true;

        socket.onopen = function (event) {
//        console.log("Socket state: "+socket.readyState);
            if (!firstConnect) {
                Messenger().post({
                    message: 'Connected!',
                    type: 'success'
                });
            }
            firstConnect = false;

            $('.input-message').prop("disabled", false);
        };

        socket.onclose = function (event) {
            Messenger().post({
                message: 'Disconnected from server, will retry...',
                type: 'error'
            });
            $('.input-message').prop("disabled", true);
        };

        // Message received on the socket
        socket.onmessage = function (event) {
            console.log(event.data);
            var eventObj = JSON.parse(event.data);

            display(eventObj);
        };

    });


    var makeMessage = function (roomName, message) {
        var msg = {};
        msg.roomName = roomName;
        msg.message = message;
        return msg;
    };


    function styleSelectedRoomInSideBar(roomName) {
        $('[id^=roomlist_]').removeClass('active');
        $('[id^=roomlist_]').find('.roomname').removeClass('font-bold');
        $(getRoomlistEntrySelector(roomName)).addClass('active');
        $(getRoomlistEntrySelector(roomName)).find('.roomname').addClass('font-bold');
    }

    var selectRoom = function (roomName) {
        console.log("Select room: " + roomName);

        // Hide all thread views, then show selected message thread
        $('[id^=threadparent_]').hide();
        $('#threadparent_'+roomName).show();

        // Hide all user lists, then show user list for selected room
        $('[id^=userlistparent_]').hide();
        $('#userlistparent_'+roomName).show();

        styleSelectedRoomInSideBar(roomName);

        // Change title
        $('#room-link').text('#' + roomName);
        $('#room-link').attr('href', 'https://reddit.com/r/'+roomName);
        $('#room-modmessage').text('[A message from the ' + roomName+ ' mods to you.]');

        resetUnreadCountForRoom(roomName);
        getStaydownForRoom(roomName).checkdown();

        currentSelectedRoomName = roomName;
    };

    function resetUnreadCountForRoom(roomName) {
        var roomObj = getRoomForName(roomName);
        if (roomObj) {
            roomObj.localUnreadCount = 0;
            setUnreadCountForRoom(roomName, roomObj.localUnreadCount);
        }
    }

    function incrementUnreadCountForRoom(roomName) {
        var roomObj = getRoomForName(roomName);
        if (roomObj) {
            roomObj.localUnreadCount++;
            setUnreadCountForRoom(roomName, roomObj.localUnreadCount);
        }
    }

    var setUnreadCountForRoom = function (roomName, count) {
        var countStr = count;
        if (count == 0) {
            countStr = "";
        }
        $(getRoomlistEntrySelector(roomName)).find('.unreadcount').text(countStr);
    };

    var setupRoomClicks = function () {
        $('.roomselect').click(function() {
            var clickRoomName = $(this).attr('data-roomname');
            console.log("Room click: " + clickRoomName);
            selectRoom(clickRoomName);
        });
    };

    var setupMessageInputHandlers = function() {
        $('.input-message').keypress(function (e) {
            if (e.charCode == 13 || e.keyCode == 13) {
//            $('#send').click()
                var messageElement = $(this);
                var message = messageElement.val();
                messageElement.val('');
                var messageObj = makeMessage(messageElement.attr('data-roomname'), message);
                socket.send(JSON.stringify(messageObj))
                getStaydownForRoom(currentSelectedRoomName).intend_down = true;

                e.preventDefault()
            }
        });
    };

    var requestMemberlist = function (roomName) {
        var messageObj = makeMessage(roomName, '##memberlist##');
        socket.send(JSON.stringify(messageObj));
    };

    // Ping socket
    var startPing = function(roomName) {
        setInterval(function () {
            if (socket.readyState == 1) {
                // console.log("Sending ping.");
                var messageObj = makeMessage(roomName, "##ping##");
                socket.send(JSON.stringify(messageObj));
            } else {
                console.log("Can't ping, connection not open.");
            }
        }, 20000);
    };

    // Uncomment this block to test network disconnect/reconnect
/*
    setInterval(function () {
        console.log("Cycling connection...");
        socket.refresh();
    }, 5000);
*/

    Messenger.options = {
        extraClasses: 'messenger-fixed messenger-on-bottom messenger-on-right',
        theme: 'flat'
    };

    function getUserEntrySelector(roomName, username) {
        return '#userlist_' + roomName + '_' + username;
    }

    // Display a message
    function getUserListSelector(roomName) {
        return '#userlistparent_' + roomName + ' #userlist';
    }

    function getThreadSelector(roomName) {
        return '#threadparent_' + roomName + ' #thread';
    }

    function getUserListParentSelector(roomName) {
        return 'userlistparent_' + roomName;
    }

    function getThreadParentId(roomName) {
        return 'threadparent_' + roomName;
    }

    function getRoomlistEntrySelector(roomName) {
        return '#roomlist_' + roomName;
    }

    function getMessageSelector(msgUuid) {
        return '#message_' + msgUuid;
    }

    function doesMessageElementExist(uuid) {
        return $(getMessageSelector(uuid)).length > 0;
    }

    var display = function (event) {
        console.log("Received event: " + event.type);
        if (event.type === 'roomlist') {
            $('#threadparent').hide();
            $('#userlistparent').hide();

            var arrayLength = event.rooms.length;
            for (var i = 0; i < arrayLength; i++) {
                var roomObj = event.rooms[i];

                var roomElement = tmpl('roomentry_tmpl', {roomObj: roomObj});
                var existingElements = $(getRoomlistEntrySelector(roomObj.name));
                if (existingElements.length > 0) {
//                console.log("Existing message, replacing with new render.");
                    existingElements.first().replaceWith(roomElement);
                } else {
//                console.log("New message, appending.");
                    $('#roomlist').append(roomElement);

                    // Clone and configure thread for this room
                    var parentClone = $('#threadparent').first().clone().appendTo('#centercol');
                    $(parentClone).find('.input-message')
                            .attr('placeholder', 'Type a message to ' + roomObj.name + '...')
                            .attr('data-roomname', roomObj.name);
                    parentClone.attr('id', getThreadParentId(roomObj.name));

                    // Make staydown scroll handler for room
                    var staydown = new StayDown({
                        target: $('#'+getThreadParentId(roomObj.name)+ ' #thread_scrollparent')[0],
                        interval: 500
                    });
                    stayDownObjs.push(staydown);

                    lastMessageUsernameForRoom.push('');

                    // Clone and configure user list for this room
                    var userlistParentClone = $('#userlistparent').first().clone().appendTo('#rightcol');
                    userlistParentClone.attr('id', getUserListParentSelector(roomObj.name));

                    var setupMentions = function() {
                        var thisRoomObj = roomObj;

                        // User mentions
                        $(parentClone).find('textarea.mention').mentionsInput({
                            onDataRequest:function (mode, query, callback) {

                                $.getJSON('@{Application.userSearch()}?roomName='+thisRoomObj.name+'&query='+query, function(responseData) {
                                    var responseObj = responseData;
                                    var responseObjs = [];

                                    function addUsersFromResponse(userArray) {
                                        for (var i = 0; i < userArray.length; i++) {
                                            var userObj = userArray[i];
                                            var respUserObj = {
                                                id: userObj.id,
                                                name: '@' + userObj.username,
                                                avatar: userObj.profileImageUrl,
                                                type: 'contact'
                                            };
                                            responseObjs.push(respUserObj);
                                        }
                                    }

                                    addUsersFromResponse(responseObj.onlineUsers);
                                    addUsersFromResponse(responseObj.offlineUsers);
//                                responseData = _.filter(responseData, function(item) { return item.name.toLowerCase().indexOf(query.toLowerCase()) > -1 });
                                    callback.call(this, responseObjs);
                                });

                                /*
                                 var data = [
                                 { id:1, name:'@pents900', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:2, name:'skwex', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:3, name:'megamatt2000', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:4, name:'Kasper Hulthin', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:5, name:'Andreas Haugstrup', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:6, name:'Pete Lacey', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:7, name:'kenneth@auchenberg.dk', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:8, name:'Pete Awesome Lacey', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' },
                                 { id:9, name:'Kenneth Hulthin', 'avatar':'http://cdn0.4dots.com/i/customavatars/avatar7112_1.gif', 'type':'contact' }
                                 ];

                                 data = _.filter(data, function(item) { return item.name.toLowerCase().indexOf(query.toLowerCase()) > -1 });

                                 callback.call(this, data);
                                 */
                            }
                        });
                    };
                    setupMentions();

                    startPing(roomObj.name);
                }

                requestMemberlist(roomObj.name);
            }

            if (firstTimeRoomList) {
                rooms = event.rooms;
                for (var i = 0; i < rooms.length; i++) {
                    rooms[i].localUnreadCount = 0;
                }
                if (preSelectRoomName) {
                    selectRoom(preSelectRoomName);
                } else {
                    selectRoom(rooms[0].name);
                }

                firstTimeRoomList = false;
            }

            styleSelectedRoomInSideBar(currentSelectedRoomName);
            setupRoomClicks();
            setupMessageInputHandlers();
        } else if (event.type === 'message') {
            console.log("Message uuid : " + event.message.uuid);
            var msgTemplateId = 'message_tmpl';
            if (getLastMessageUsernameForRoom(event.room.name) === event.user.username) {
                msgTemplateId = 'messageshort_tmpl';
            }
            var msg = tmpl(msgTemplateId, {event: event});
            if (doesMessageElementExist(event.message.uuid)) {
//                console.log("Existing message, replacing with new render.");
                var msgObjects = $(getMessageSelector(event.message.uuid));
                msgObjects.first().replaceWith(msg);
            } else {
                console.log("New message, appending.");

                var roomName = event.room.name;
                if (!hasFocus) {
                    numNewMessagesTotal++;
                    updateTitle();

                    incrementUnreadCountForRoom(roomName);
                } else if (roomName != currentSelectedRoomName) {
                    incrementUnreadCountForRoom(roomName);
                }

                $(getThreadSelector(event.room.name)).append(msg);
            }

            setLastMessageUsernameForRoom(event.room.name, event.user.username);

            jQuery(getMessageSelector(event.message.uuid)+' .timeago').timeago();
        } else if (event.type === 'join') {
            if ($(getUserEntrySelector(event.room.name, event.user.username)).length == 0) {
                $(getUserListSelector(event.room.name)).append(tmpl('userentry_tmpl',
                        {roomName: event.room.name, user: event.user}));
            }
        } else if (event.type === 'leave') {
            $(getUserEntrySelector(event.room.name, event.user.username)).remove();
        } else if (event.type === 'roominfo') {
            if (event.banner) {
                $('#room-modmessage').text(event.banner);
            } else {
                $('#room-modmessage').text('');
            }
            if (event.iconUrl) {
                $('#room-icon').attr('src', event.iconUrl);
                $('#room-icon').show();
            } else {
                $('#room-icon').hide();
            }
            if (event.isModerator) {
                $('#room-pref').attr('href', '@{RoomManage.roomPrefs}?roomName=' + event.room.name);
                $('#room-pref').removeClass('hidden');
            } else {
                $('#room-pref').addClass('hidden');
            }
        } else if (event.type === 'memberlist') {
            console.log("Member list for " + event.room.name);
            var arrayLength = event.users.length;
            for (var i = 0; i < arrayLength; i++) {
                var userObj = event.users[i];
                var username = userObj.username;

                var userHtml = tmpl('userentry_tmpl',
                        {roomName: event.room.name, user: userObj});
                var existingElements = $(getUserEntrySelector(event.room.name, username));
                if (existingElements.length > 0) {
//                    console.log("Existing user, replacing with new render.");
                    existingElements.first().replaceWith(userHtml);
                } else {
//                    console.log("New user, appending.");
                    // todo insert at sorted location
                    $(getUserListSelector(event.room.name)).append(userHtml);
                }

//                $('#userlist').append();
            }
        }

//        $('#thread').scrollTo('max')
    };

    var previewLoaded = function (e) {
        // Makes the UI feel a little more responsive to trigger a check right when preview loads
        getStaydownForRoom(currentSelectedRoomName).checkdown();
    };

    var updateTitle = function () {
        var title = 'breaker';
        if (numNewMessagesTotal > 0) {
            title = '(' + numNewMessagesTotal + ') ' + title;
        }
        document.title = title;
    };
    updateTitle();

    var firstConnect = true;

    // Stuff to do with window focus and unread messages

    var onBlur = function onBlur() {
        hasFocus = false;
    };
    var onFocus = function onFocus() {
        hasFocus = true;
        numNewMessagesTotal = 0;
        updateTitle();
        resetUnreadCountForRoom(currentSelectedRoomName);
    };

    if (/*@cc_on!@*/false) { // check for Internet Explorer
        document.onfocusin = onFocus;
        document.onfocusout = onBlur;
    } else {
        window.onfocus = onFocus;
        window.onblur = onBlur;
    }

</script>

</body>
